# REST API Plan

## 1. Resources

- **Flashcards**: Maps to the `flashcards` table. Represents individual flashcards created manually or saved after AI generation approval. Validations enforce constraints such as: `front` must be between 1 and 200 characters, `back` must be between 1 and 500 characters, and `source` must be one of `manual`, `ai-full`, or `ai-edited`.
- **Generations**: Maps to the `generations` table. Captures records of AI generation processes including details such as `source_text_length` (must be between 1000 and 10000), generation duration, and model used. It also represents the linkage to flashcards created in each generation.
- **GenerationsErrors**: Maps to the `generations_errors` table. Stores error information related to AI flashcard generation processes.

## 2. Endpoints

### 2.1 Flashcards Endpoints

1. **List Flashcards**
   - **Method**: GET
   - **URL Path**: `/api/flashcards`
   - **Description**: Retrieves a list of flashcards for the authenticated user. Supports pagination, filtering (e.g., by source), and sorting.
   - **Query Parameters**:
     - `page` (default 1)
     - `limit` (default 10)
     - `sort` (e.g. `created_at`)
     - `order` (e.g. `asc` or `desc`)
     - `filter` (e.g. `source=manual`)
   - **Response Payload**:

     {
     "flashcards": [
     { "id": 1, "front": "Question?", "back": "Answer.", "source": "manual", "generation_id": null, "created_at": "...", "updated_at": "..." },
     ...
     ],
     "pagination": { "total": 50, "page": 1, "limit": 10 }
     }
     - **Success Codes**: 200 OK

   - **Error Codes**: 401 Unauthorized, 500 Internal Server Error

2. **Create a Flashcard (Manual or AI-approved)**
   - **Method**: POST
   - **URL Path**: `/api/flashcards`
   - **Description**: Saves approved flashcard(s) to the database. This endpoint handles both:
     - Manual creation of flashcards (with `source` = `manual`).
     - Saving of flashcards generated by AI (approved proposals). For AI-generated flashcards, if the data is identical to the original proposal (no modifications) – `source` will be `ai-full`, but if the user made any changes – `ai-edited`.
   - **Request Payload** (example of sending a list of flashcards):

     {
     "flashcards": [
     {
     "front": "What is REST?",
     "back": "A software architectural style for building APIs.",
     "source": "manual",
     "generation_id": null
     },
     {
     "front": "What is GraphQL?",
     "back": "A query language for APIs.",
     "source": "ai-full",
     "generation_id": 5
     },
     {
     "front": "What is AI?",
     "back": "A branch of computer science dealing with intelligent behavior.",
     "source": "ai-edited",
     "generation_id": 5
     }
     ]
     }
     - **Validations**:
       - For all flashcards:
         - `front`: Must be between 1 and 200 characters.
         - `back`: Must be between 1 and 500 characters.
         - `source`: Must be one of `manual`, `ai-full`, or `ai-edited`.
       - For flashcards with `source` set to an AI value (`ai-full` or `ai-edited`): `generation_id` is required.

   - **Response Payload**:

     {
     "message": "Flashcards saved successfully",
     "flashcards": [
     { "id": 10, "front": "What is REST?", "back": "A software architectural style for building APIs.", "source": "manual", "created_at": "..." },
     { "id": 11, "front": "What is GraphQL?", "back": "A query language for APIs.", "source": "ai-full", "generation_id": 5, "created_at": "..." },
     { "id": 12, "front": "What is AI?", "back": "A branch of computer science dealing with intelligent behavior.", "source": "ai-edited", "generation_id": 5, "created_at": "..." }
     ]
     }
     - **Success Codes**: 201 Created

   - **Error Codes**: 400 Bad Request, 401 Unauthorized

3. **Get Flashcard Details**
   - **Method**: GET
   - **URL Path**: `/api/flashcards/:id`
   - **Description**: Retrieves the details of a specific flashcard.
   - **Response Payload**:

     { "id": 10, "front": "...", "back": "...", "source": "manual", "generation_id": null, "created_at": "..." }
     - **Success Codes**: 200 OK

   - **Error Codes**: 404 Not Found, 401 Unauthorized

4. **Update Flashcard**
   - **Method**: PUT
   - **URL Path**: `/api/flashcards/:id`
   - **Description**: Updates an existing flashcard.
   - **Request Payload** (fields allowed for update):

     { "front": "Updated question?", "back": "Updated answer." }
     - **Response Payload**:

     { "message": "Flashcard updated successfully", "flashcard": { "id": 10, "front": "Updated question?", "back": "Updated answer.", "updated_at": "..." } }
     - **Success Codes**: 200 OK

   - **Error Codes**: 400 Bad Request, 404 Not Found, 401 Unauthorized

5. **Delete Flashcard**
   - **Method**: DELETE
   - **URL Path**: `/api/flashcards/:id`
   - **Description**: Deletes a flashcard from the system.
   - **Response Payload**:

     { "message": "Flashcard deleted successfully" }
     - **Success Codes**: 200 OK

   - **Error Codes**: 404 Not Found, 401 Unauthorized

### 2.2 Generations Endpoints

1. **Trigger Flashcard Generation (AI Process)**
   - **Method**: POST
   - **URL Path**: `/api/generations`
   - **Description**: Initiates the AI flashcard generation process using the provided text input.
   - **Request Payload**:

     {
     "input_text": "<text between 1000 and 10000 characters>"
     }
     - **Validations**:
       - `input_text` length must be between 1000 and 10000 characters.

   - **Business Logic**:
     - Initiates an AI service call to generate between 1 and 30 flashcards.
     - If no flashcards are generated, an error message "Failed to generate flashcards" is returned.
   - **Response Payload**:

     { "message": "Generation initiated", "generation": { "id": 5, "model": "gpt-4", "created_at": "..." }, "flashcards": [ /* generated flashcard proposals */ ] }
     - **Success Codes**: 201 Created

   - **Error Codes**: 400 Bad Request, 500 Internal Server Error

2. **Get Generation Details**
   - **Method**: GET
   - **URL Path**: `/api/generations/:id`
   - **Description**: Retrieves details of a specific generation process including associated flashcards.
   - **Response Payload**:

     { "id": 5, "model": "gpt-4", "created_at": "...", "flashcards": [ { "id": 10, ... } ] }
     - **Success Codes**: 200 OK

   - **Error Codes**: 404 Not Found, 401 Unauthorized

3. **List Generations**
   - **Method**: GET
   - **URL Path**: `/api/generations`
   - **Description**: Retrieves a paginated list of generation records for the authenticated user.
   - **Query Parameters**: Similar to flashcards listing (page, limit, order, sort, filter)
   - **Response Payload**: Includes generation summary details with pagination information.
     - **Success Codes**: 200 OK
   - **Error Codes**: 401 Unauthorized, 500 Internal Server Error

4. **Get Generation Errors**
   - **Method**: GET
   - **URL Path**: `/api/generations/:id/errors`
   - **Description**: Retrieves error logs related to a particular generation process.
   - **Response Payload**:

     { "generation_id": 5, "errors": [ { "id": 2, "error_message": "AI generation failed due to ...", "created_at": "..." } ] }
     - **Success Codes**: 200 OK

   - **Error Codes**: 404 Not Found, 401 Unauthorized

## 3. Authentication and Authorization

- **Mechanism**: JWT-based authentication leveraging Supabase Auth. Upon successful authentication, a JWT token is issued and must be included in the `Authorization` header as a Bearer token for subsequent API requests.
- **Middleware**: Each protected endpoint uses middleware to validate the token and extract the `user_id`. The database row-level security (RLS) policies further ensure that users only access their own records.

## 4. Validation and Business Logic

### Validation Conditions (from Database Schema)

- **Flashcards**:
  - `front`: Must be between 1 and 200 characters (validated both in the API and at the database level).
  - `back`: Must be between 1 and 500 characters.
  - `source`: Must be one of `manual`, `ai-full`, or `ai-edited` (if provided).

- **Generations**:
  - `input_text` length must be validated on the API side to ensure it is between 1000 and 10000 characters before triggering generation.
  - Ensure that at least one and no more than 30 flashcards are created. If generation yields 0 flashcards, return an error message "Failed to generate flashcards".

### Business Logic Implementation

- **Flashcard Generation Workflow**:
  - The endpoint `/api/generations` accepts input text, performs validation, and then interfaces with the AI service to generate flashcard proposals.
  - On success, the generated flashcard proposals are returned along with the generation record. They are not saved in the database; instead, they are displayed in the UI as proposals.

- **Saving Flashcards**:
  - After approval by the user, the front-end sends the complete data of approved flashcards (as an array of objects) to the POST `/api/flashcards` endpoint. For manually created flashcards, `source` is set to `manual`, while for approved AI-generated proposals, `source` is set to `ai-full` (if no changes were made) or `ai-edited` (if modifications were made). The endpoint saves each record in the `flashcards` table.

- **Security and Performance Measures**:
  - Rate limiting on resource-intensive endpoints (e.g., `/api/generations`) to prevent abuse.
  - Use of database indexes (e.g., on `user_id`, `generation_id`) for efficient querying.
  - Comprehensive error handling and logging across endpoints.
